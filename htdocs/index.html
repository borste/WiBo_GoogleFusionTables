<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>Weihnachtsmarkt Finder</title>
	<link href="style.css" rel="stylesheet" type="text/css">
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
	<link href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
	
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>

    <script type="text/javascript">
		var map;
		var layer;
		var tableId = '1rgZDIBtzhMZgBqzVwRMOvjs3RbeK2HE74bY9ivY';
		var tableIdHeatmap = '1mYQYgSuc3D8RZeklmSLOB2XcOhlETwXqcXXv1DA';
		var locationColumn = 'geo_adresse';	  
		var apiKey = "AIzaSyBs-9DEpRuxKFYrlbp7VnlTTK1MikDopBU";		
		var geocoder = new google.maps.Geocoder();
		var germanyBerlin = new google.maps.LatLng(52.524577,13.393501);
		
		$(function() {
			$( "#date" ).datepicker();
		});
		
		//Drop Downs initial aus Fusion Table befüllen
		request();
  
		function initialize() {	
		
			map = new google.maps.Map(document.getElementById('map-canvas'), {
				center: germanyBerlin,
				zoom: 9,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});

			layer = new google.maps.FusionTablesLayer({
				query: {
					select: locationColumn,
					from: tableId
				},					
				map: map
			});
			
			//KML-Daten für Bezriksgrenznen
			layerPolyDescrict = new google.maps.FusionTablesLayer({
				query: {
					select: 'geometry',
					from: tableIdHeatmap
				},
				styles: [{
					polygonOptions: {
						fillColor: "#b10303",
						fillOpacity: 0.00001,
						strokeColor: "#b10303",
						strokeWeight: 1.5,
						strokeOpacity: 0.3,
						zIndex:0
					}
				}]	
			});
			
			//KML-Daten für Bezriksgrenznen
			layerEvaluationCountDestricts = new google.maps.FusionTablesLayer({
				query: {
					select: 'geometry',
					from: tableIdHeatmap
				},			
				styleId: 2,
				templateId: 2				
			});			

			//Datum 
			google.maps.event.addDomListener(document.getElementById('dateButton'), 'click', function() {
				updateMap(layer, tableId, locationColumn,"date");
			});				
			
			//Bezirk
			google.maps.event.addDomListener(document.getElementById('destrict'),'change', function() {
				updateMap(layer, tableId, locationColumn,"destrict");
			});

			//Marktsortiment
			google.maps.event.addDomListener(document.getElementById('sortiment'), 'change', function() {
				updateMap(layer, tableId, locationColumn,"sortiment");
			});

			//Checkbox Fahrgeschäfte
			google.maps.event.addDomListener(document.getElementById('stage_technology'), 'change', function() {
				updateMap(layer, tableId, locationColumn,"stage_technology");
			});
			
			//Checkbox freier Eintritt
			google.maps.event.addDomListener(document.getElementById('free_entry'), 'change', function() {
				updateMap(layer, tableId, locationColumn,"free_entry");
			});		

			//Auswertung 
			google.maps.event.addDomListener(document.getElementById('evaluation'),'change', function() {
				updateMapLayer("evaluation");
			});
			
		}

		// Weihnachtsmärke ein/ausblenden
		function toggle_markets() {
			if(layer.map) {
				layer.setMap(null);
			} else  {
				layer.setMap(map);	  
			}
		}
		
		// Bezirksgrenzen ein/ausblenden
		function toggle_descrictPolygon() {
			if(layerPolyDescrict.map) {
				layerPolyDescrict.setMap(null);
			} else  {
				layerPolyDescrict.setMap(map);	  								
				//Marker über Layer anzeigen
				if(layer.map) {
					layer.setMap(map);
				}			
			}
		}		
		
		function clearMaps(){
			layerPolyDescrict.setMap(null);
			layerEvaluationCountDestricts.setMap(null);
		}
		
		/* 	Zusammenbau der einzelnen Where-Statements, zu einem SQL Query, um verschiedene Filter zu kombinieren */
		var queries = new Array();
		function getWhereStatements(){		
			var out = "";	
			var j=0;
			for (var i in queries)
			{
				//debug
				console.log('queries[\''+i+'\'] is ' + queries[i] + " Länge: " + queries[i].length + "Zahl: "+j);
				//mehr als ein element und vorhandener query
				out+= (queries[i].length == 0 || j==0 ? "" : " AND ") + queries[i];			
				//zählen für AND-Kostrukt
				j++
			}
			//Im Fehlerfall das erste AND abschneiden
			if(out.substring(0, 5)== " AND "){
				out = out.replace(' AND ','');
			}
			//Debug
			console.log("QUERY:" + out);
			return out;
		}
		
		/* nach Selektion eines Filters erfolgt hier die Fusion-Table-Abfrage und Darstellung*/
		function updateMap(layer, tableId, locationColumn, element) {
			var value = document.getElementById(element).value;			
			if (value) {					
					switch(element){
						case "date":		
							var whereStatment = (value=="" ? "" : "von <= '" + value + "' AND bis >= '" + value + "'");						
							queries["date"] = whereStatment;													
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements()
								}
							});			
							break;					
						case "destrict":		
							var whereStatment = (value=="all" ? "" : "bezirk = '" + value + "'");						
							queries["destrict"] = whereStatment;						
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements()
								}
							});									
							break;
						case "sortiment":	
							var whereStatment = (value=="all" ? "" : "sortiment = '" + value + "'");
							queries["sortiment"] = whereStatment;		
							layer.setOptions({	
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements()
								}
							});	
							break;		
						case "stage_technology":		
							tmp = (document.getElementById(element).checked == true ? 1 : 0);	
							//deaktiviert heißt alle mit oder ohne Fahrgeschäft
							var	whereStatment = (tmp == 0 ? "" : "fahrgeschaefte = '" + tmp + "'");
							
							queries["stage_technology"] = whereStatment;
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements()
								}	
							});																	
							break;									
						case "free_entry":		
							tmp = (document.getElementById(element).checked == true ? 0 : 1);	
							//deaktiviert heißt alle mit oder ohne Eintrittspreis
							var	whereStatment = (tmp == 1 ? "" : "eintrittspreis = '" + tmp + "'");
							
							queries["free_entry"] = whereStatment;
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements()
								}	
							});																	
							break;	
						default:
							layer.setOptions({		
								query: {
									select: locationColumn,
									from: tableId
								}
							});	
						}					
					//DropDowns aktualisieren in Abhängigkeit der Filter
					//request();
			} else {
				// notwendig für "Alle anzeigen"
				layer.setOptions({	
					query: {
						select: locationColumn,
						from: tableId
					}
				});	
			}	
		}
	// Darstellung der Heat-Maps
	function updateMapLayer(element) {
		var value = document.getElementById(element).value;			
		console.log('updateMapLayer(element)' + value);
	
		switch(value){			
				case "count":	
					layerEvaluationCountDestricts.setMap(map);
					map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(document.getElementById('legendEvaluationCountDestricts'));
					$('#legendEvaluationCountDestricts').css('visibility', 'show');
					break;	
				default:
					clearMaps();
					$('#legendEvaluationCountDestricts').css('visibility', 'hidden');
					
		}								
	}
	
	// REST-Anfrage, Query für initiales Laden
	function request(){
	
		var listDestrictsQuery = "SELECT bezirk FROM " + tableId + " GROUP BY bezirk";
			$.get('https://www.googleapis.com/fusiontables/v1/query?sql=' + listDestrictsQuery + '&key=' + apiKey, function(data) {
				listDestricts(data);
			// console.log(data);
		});	

		//var listSortimentQuery = "SELECT sortiment FROM " + tableId + " " + (getWhereStatements()=="" ? "" : "WHERE " + getWhereStatements()) + "  GROUP BY sortiment";
		var listSortimentQuery = "SELECT sortiment FROM " + tableId + " GROUP BY sortiment";
		$.get('https://www.googleapis.com/fusiontables/v1/query?sql=' + listSortimentQuery + '&key=' + apiKey, function(data) {
			listSortiment(data);
		// console.log(data);
		});			
		
	/*	var listDateQuery = "SELECT von,bis FROM " + tableId + " WHERE von >= '12/8/2012' AND bis <= '12/8/2012'";
			$.get('https://www.googleapis.com/fusiontables/v1/query?sql=' + listDateQuery + '&key=' + apiKey, function(data) {
				listDestricts(data);
			 console.log(data);
		});			*/
	}	  

	//Bezirke Drop-Down
	function listDestricts(data){
		//$('#destrict').empty();
		for (var i in data['rows'])
		{
			$('#destrict').append('<option>' + data['rows'][i] + '</option>');
			//console.log('data[\''+i+'\'] is ' + data['rows'][i]);
		}		
	}
	
	//Marktsortiment Drop-Down
	function listSortiment(data){
		//HTML-Element leeren, bevor es anhand der Filter neu befüllt wird
		//$('#sortiment').empty();
		
		for (var i in data['rows'])
		{
			$('#sortiment').append('<option>' + data['rows'][i] + '</option>');
		}		
	}	 
	
	// Adressen-Zoom
	function zoomtoaddress() {
		// Use the geocoder to geocode the address
		geocoder.geocode(
			{'address': document.getElementById("address").value + ' .' + 'berlin' }, function(results, status) {
				// If the status of the geocode is OK
				if (status == google.maps.GeocoderStatus.OK) {
					// Change the center and zoom of the map
					map.setCenter(results[0].geometry.location);
					map.setZoom(15);
					var marker = new google.maps.Marker({
						position: results[0].geometry.location,
						map: map
						/*	  ,
						icon: "wht_pushpin.png",
						title: 'Ihr Suchtreffer'
						*/    
					});  			  
				} 
			}
		);
	}
	
    google.maps.event.addDomListener(window, 'load', initialize);
	
	</script>
    </head>
    <body>
		<div class="header"></div>
		
		<div class="box">
			<div class="left">
				<h2>Besuchertag</h2>				
				<input type="text" id="date" value="" class="text">
				<input type="button" value="" id="dateButton" class="button refresh"/></br>
				
				<h2>Filter</h2>
				<label>Bezirk</label>
				<select id="destrict">
					<option value="all">--Alle--</option>
				</select>
				<label>Marktsortiment</label>
				<select id="sortiment">
					<option value="all">--Alle--</option>
				</select>
				<br/>
				<div class="checkbox">
					<input id="free_entry" type="checkbox" value="on">Eintritt frei
				</div>
				<div class="checkbox">
					<input id="stage_technology" type="checkbox" value="on"  class="checkbox"/>Fahrgesch&auml;fte
				</div>
				<div class="copy">
						<h2>Impressum</h2>
						Team: Manuel W., Patrick B.<br/>
						Veranstaltung: Wissenschaftliches Projekt
						Source: <a href="https://github.com/borste/WiBo_GoogleFusionTables">Git-Repository</a>
				</div>
			</div>
			<div class="content">
				<div class="ctop">
					<div class="ctop-left">
						<h2>Weihnachtsm&auml;rkte in Deiner N&auml;he</h2>
						<input type="text" id="address" onclick="this.value=''" value="Deine Adresse (Str., Nr)" class="text">
						<input type="button" onclick="zoomtoaddress()" value="Finden" class="button">
					</div>
					<div class="ctop-right">
						<h2>Ein-/ Ausblenden</h2>
						<a href="#" onclick="toggle_markets()" class="toggle">M&auml;rkte</a>
						<a href="#" onclick="toggle_descrictPolygon()" class="toggle">Bezirksgrenzen</a>
					</div>
					<div class="clear"></div>
				</div>
				<div id="map-canvas"></div>	
				<div class="cbot">
					<h2 style="display:inline;margin-right:10px;">Statistik</h2>
					<select id="evaluation">
						<option value="none">-- Keine --</option>
						<option value="count">Anzahl der Berliner Weihnachtsm&auml;rkte pro Bezirk</option>			
					</select>
				</div>
				
			</div>
			<div class="clear"></div>
		</div>
	
		<!-- Hidden, Legend -->
		<div id="legendEvaluationCountDestricts" style="visibility:hidden;">
			Anzahl der Berliner Weihnachtsm&auml;rkte
		</div>
	</body>
</html>