<!DOCTYPE html>
<html>
    <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>Fusion Tables Layer Example: Dynamic styles and templates</title>
	<link href="/fusiontables/docs/samples/style/default.css" rel="stylesheet" type="text/css">
	
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
  
	
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
		var map;
		var layer;
		var tableId = '1rgZDIBtzhMZgBqzVwRMOvjs3RbeK2HE74bY9ivY';
		var locationColumn = 'geo_adresse';	  
		var apiKey = "AIzaSyBs-9DEpRuxKFYrlbp7VnlTTK1MikDopBU";
		var geocoder = new google.maps.Geocoder();
		
		$(function() {
			$( "#date" ).datepicker();
		});
		
		//Drop Downs initial aus Fusion Table befüllen
		request();
  
		function initialize() {
			map = new google.maps.Map(document.getElementById('map-canvas'), {
				center: new google.maps.LatLng(52.524577,13.393501),
				zoom: 9,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});

			layer = new google.maps.FusionTablesLayer({
				query: {
					select: locationColumn,
					from: tableId
					},
				map: map
			});
			

			//Datum 
			google.maps.event.addDomListener(document.getElementById('dateButton'), 'click', function() {
				updateMap(layer, tableId, locationColumn,"date");
			});				
			
			//Bezirk
			google.maps.event.addDomListener(document.getElementById('destrict'),'change', function() {
				updateMap(layer, tableId, locationColumn,"destrict");
			});

			//Marktsortiment
			google.maps.event.addDomListener(document.getElementById('sortiment'), 'change', function() {
				updateMap(layer, tableId, locationColumn,"sortiment");
			});

			//Checkbox Fahrgeschäfte
			google.maps.event.addDomListener(document.getElementById('stage_technology'), 'change', function() {
				updateMap(layer, tableId, locationColumn,"stage_technology");
			});
			
			//Checkbox freier Eintritt
			google.maps.event.addDomListener(document.getElementById('free_entry'), 'change', function() {
				updateMap(layer, tableId, locationColumn,"free_entry");
			});	
		}

		// Weihnachtsmärke ein/ausblenden
		function toggle_markets() {
			if(layer.map) {
				layer.setMap(null);
			} else  {
				layer.setMap(map);	  
			}
		}
		
		/* 	Zusammenbau der einzelnen Where-Statements, zu einem SQL Query, um verschiedene Filter zu kombinieren */
		var queries = new Array();
		function getWhereStatements(field){		
			var out = "";	
			var j=0;
			for (var i in queries)
			{
				//debug
				console.log('queries[\''+i+'\'] is ' + queries[i] + " Länge: " + queries[i].length + "Zahl: "+j);
				//mehr als ein element und vorhandener query
				out+= (queries[i].length == 0 || j==0 ? "" : " AND ") + queries[i];			
				//zählen für AND-Kostrukt
				j++
			}
			//Im Fehlerfall das erste AND abschneiden
			if(out.substring(0, 5)== " AND "){
				out = out.replace(' AND ','');
			}
			//Debug
			console.log("QUERY:" + out);
			return out;
		}
		
		/* nach Selektion eines Filters erfolgt hier die Fusion-Table-Abfrage und Darstellung*/
		function updateMap(layer, tableId, locationColumn, element) {
			var value = document.getElementById(element).value;			
			if (value) {					
					switch(element){
						case "date":		
							var whereStatment = (value=="" ? "" : "von <= '" + value + "' AND bis >= '" + value + "'");						
							queries["date"] = whereStatment;													
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements("date")
								}
							});			
							break;					
						case "destrict":		
							var whereStatment = (value=="all" ? "" : "bezirk = '" + value + "'");						
							queries["destrict"] = whereStatment;						
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements("destrict")
								}
							});			
							break;
						case "sortiment":	
							var whereStatment = (value=="all" ? "" : "sortiment = '" + value + "'");
							queries["sortiment"] = whereStatment;		
							layer.setOptions({	
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements("sortiment")
								}
							});	
							break;		
						case "stage_technology":		
							tmp = (document.getElementById(element).checked == true ? 1 : 0);	
							//deaktiviert heißt alle mit oder ohne Fahrgeschäft
							var	whereStatment = (tmp == 0 ? "" : "fahrgeschaefte = '" + tmp + "'");
							
							queries["stage_technology"] = whereStatment;
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements("stage_technology")
								}	
							});																	
							break;									
						case "free_entry":		
							tmp = (document.getElementById(element).checked == true ? 0 : 1);	
							//deaktiviert heißt alle mit oder ohne Eintrittspreis
							var	whereStatment = (tmp == 1 ? "" : "eintrittspreis = '" + tmp + "'");
							
							queries["free_entry"] = whereStatment;
							layer.setOptions({						
								query: {
									select: locationColumn,
									from: tableId,
									where: getWhereStatements("free_entry")
								}	
							});																	
							break;	
						default:
							layer.setOptions({		
								query: {
									select: locationColumn,
									from: tableId
								}
							});	
					}					
			} else {
				// notwendig für "Alle anzeigen"
				layer.setOptions({	
					query: {
						select: locationColumn,
						from: tableId
					}
				});	
			}	
		}
	
	// REST-Anfrage, Query für initiales Laden
	function request(){
		var listDestrictsQuery = "SELECT bezirk FROM " + tableId + " GROUP BY bezirk";
			$.get('https://www.googleapis.com/fusiontables/v1/query?sql=' + listDestrictsQuery + '&key=' + apiKey, function(data) {
				listDestricts(data);
			// console.log(data);
		});	

		var listDestrictsQuery = "SELECT sortiment FROM " + tableId + " GROUP BY sortiment";
		$.get('https://www.googleapis.com/fusiontables/v1/query?sql=' + listDestrictsQuery + '&key=' + apiKey, function(data) {
			listSortiment(data);
		// console.log(data);
		});			
		
	/*	var listDateQuery = "SELECT von,bis FROM " + tableId + " WHERE von >= '12/8/2012' AND bis <= '12/8/2012'";
			$.get('https://www.googleapis.com/fusiontables/v1/query?sql=' + listDateQuery + '&key=' + apiKey, function(data) {
				listDestricts(data);
			 console.log(data);
		});			*/
	}	  

	//Bezirke Drop-Down
	function listDestricts(data){
		for (var i in data['rows'])
		{
			$('#destrict').append('<option>' + data['rows'][i] + '</option>');
			//console.log('data[\''+i+'\'] is ' + data['rows'][i]);
		}		
	}
	
	//Marktsortiment Drop-Down
	function listSortiment(data){
		for (var i in data['rows'])
		{
			$('#sortiment').append('<option>' + data['rows'][i] + '</option>');
		}		
	}	 
	
	// Adressen-Zoom
	function zoomtoaddress() {
		// Use the geocoder to geocode the address
		geocoder.geocode(
			{'address': document.getElementById("address").value + ' .' + 'berlin' }, function(results, status) {
				// If the status of the geocode is OK
				if (status == google.maps.GeocoderStatus.OK) {
					// Change the center and zoom of the map
					map.setCenter(results[0].geometry.location);
					map.setZoom(15);
					var marker = new google.maps.Marker({
						position: results[0].geometry.location,
						map: map
						/*	  ,
						icon: "wht_pushpin.png",
						title: 'Ihr Suchtreffer'
						*/    
					});  			  
				} 
			}
		);
	}

    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    </head>
    <body>
		Git: <a href="https://github.com/borste/WiBo_GoogleFusionTables">GIT-Repo</a> <br/>
		Team: Manuel W, Patrick B.<br/>
		Stand: 13.01.2013<br/>
		<br />
		<div id="map-canvas" style="height:500px;width:500px"></div>		
		<div>
			Datum (12/24/2012)<input type="text" id="date" value=""><input type="button" value="Refresh" id="dateButton" /></br>
		
			<input type="text" id="address" onclick="this.value=''" value="Ihre Adresse (Str., Nr)" class="formtypo">
			<input type="button" onclick="zoomtoaddress()" value="Finden" class="button1">
		<a href="#" onclick="toggle_markets()">M&auml;rkte An-/Auschalten</a> <br />
		<label>Bezirk</label>
		<select id="destrict">
			<option value="all">--Alle--</option>
		</select>

		<label>Marktsortiment</label>
		<select id="sortiment">
			<option value="all">--Alle--</option>
		</select>
		<br />
		<input id="stage_technology" type="checkbox" value="on" />
		<label>Fahrgesch&auml;fte</label>
		<br />
		<input id="free_entry" type="checkbox" value="on" />
		<label>freier Eintritt?</label>
		</div>
	</body>
</html>